<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EstadÃ­sticas</title>

  <link rel="stylesheet" href="styles.css" />

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- jsPDF (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>

<body>
  <header>
    <h1>EstadÃ­sticas de Ventas</h1>
    <img src="logo.webp" alt="Logo Panificados" class="logo-app">
    <div class="header-actions">
      <button id="volverBtn">â† Volver</button>
      <button id="exportarCSVBtn">â¬‡ï¸ Exportar CSV</button>
      <button id="exportarPDFDiaBtn">ğŸ“„ Exportar PDF del DÃ­a</button>
      <button id="exportarPDFMesBtn">ğŸ—“ï¸ Exportar PDF del Mes</button>
      <button id="guideBtn">â” GuÃ­a rÃ¡pida</button>
      <button id="toggleThemeBtn">ğŸŒ™ Modo oscuro</button>
      <button id="resetEstadisticasBtn" class="danger">ğŸ—‘ Resetear estadÃ­sticas</button>
    </div>
  </header>

  <main>

    <!-- RESUMEN -->
    <section id="resumenSection">
      <h2>Resumen rÃ¡pido</h2>
      <div id="resumenTotales"></div>
    </section>

    <!-- CHARTS PRINCIPALES -->
    <section id="charts">
      <div class="chart-card">
        <h3>Top productos mÃ¡s vendidos</h3>
        <canvas id="chartTopProductos" height="200"></canvas>
      </div>

      <div class="chart-card">
        <h3>Ventas por categorÃ­a</h3>
        <canvas id="chartCategorias" height="200"></canvas>
      </div>

      <div class="chart-card">
        <h3>Ingresos reales vs venta esperada</h3>
        <canvas id="chartIngresos" height="200"></canvas>
      </div>

      <div class="chart-card">
        <h3>Promedio de unidades vendidas por producto</h3>
        <canvas id="chartPromedios" height="200"></canvas>
      </div>

      <div class="chart-card">
        <h3>Ganancia por turno (dÃ­a)</h3>
        <canvas id="chartDia" height="200"></canvas>
      </div>

      <div class="chart-card">
        <h3>Ingreso por dÃ­a (mes)</h3>
        <canvas id="chartVentasPorDia" height="200"></canvas>
      </div>

      <div class="chart-card">
        <h3>Ganancias por dÃ­a (mes)</h3>
        <canvas id="chartGananciasPorDia" height="200"></canvas>
      </div>
    </section>

    <!-- TABLA POR PRODUCTO -->
    <section id="tablaSection">
      <h3>Detalle por producto</h3>
      <table id="tablaProductos">
        <thead>
          <tr>
            <th>Producto</th>
            <th>CategorÃ­a</th>
            <th>Stock</th>
            <th>Vendidos</th>
            <th>Precio Venta</th>
            <th>Ganancia total</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- TABLA POR DÃA DEL MES -->
    <section id="tablaDiasSection">
      <h3>Resumen diario del mes</h3>
      <table id="tablaDias">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Ingreso</th>
            <th>Ganancia</th>
            <th>Costo vendido</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

  </main>

  <!-- PIE DE PÃGINA -->
  <footer>
    <p>&copy; 2025 - Cristian Daniel Altamiranda</p>
  </footer>

  <!-- ============================
        MODAL: GUÃA RÃPIDA DE USO
       ============================ -->
  <div id="modalGuia" class="modal" aria-hidden="true" role="dialog" aria-labelledby="modalGuiaTitle">
    <div class="modal-content">
      <button class="modal-close" id="modalGuiaClose" aria-label="Cerrar guÃ­a">âœ–</button>
      <h2 id="modalGuiaTitle">ğŸŸ¦ GUÃA RÃPIDA DE USO DEL SISTEMA DE PANIFICADOS</h2>
      <div class="modal-body">
        <p><strong>ğŸ‘¤ 1. Inicio de sesiÃ³n</strong></p>
        <p>El sistema cuenta con dos usuarios por defecto:</p>
        <ul>
          <li><code>admin / 1234</code> â†’ Administrador</li>
          <li><code>vendedor / 1234</code> â†’ Vendedor</li>
        </ul>
        <p>Ambos pueden usar el sistema; por ahora ambos pueden crear, editar y eliminar productos.</p>

        <hr>

        <p><strong>ğŸ“¦ 2. Crear un producto nuevo</strong></p>
        <ol>
          <li>Ir a â€œAgregar productoâ€.</li>
          <li>Completar: Nombre, Precio costo, Precio venta, CategorÃ­a, Stock inicial, Stock mÃ­nimo deseado.</li>
          <li>Si la categorÃ­a no existe: escribirla y <strong>hacer clic en "Agregar CategorÃ­a"</strong> (no presionar Enter para agregar la categorÃ­a).</li>
          <li>IMPORTANTE: si apretÃ¡s Enter en el formulario, se guarda directamente el producto.</li>
        </ol>

        <hr>

        <p><strong>ğŸ“¥ 3. Agregar stock</strong></p>
        <p>En el Ã­ndice (pantalla principal): hacer clic en â€œSumar stockâ€ del producto, ingresar cantidad y confirmar. El sistema actualiza stock, costo total y venta esperada.</p>

        <hr>

        <p><strong>ğŸ›’ 4. Registrar ventas</strong></p>
        <p>En el Ã­ndice, presionar â€œVenderâ€. El sistema actualiza stock, vendidos del dÃ­a, ingreso real del dÃ­a y ganancia.</p>

        <hr>

        <p><strong>ğŸ”„ 5. Devolver una venta</strong></p>
        <p>Solo se pueden devolver ventas del dÃ­a activo. Una vez cerrado el dÃ­a, las ventas quedan bloqueadas y no pueden devolverse.</p>

        <hr>

        <p><strong>ğŸ”” 6. Alertas de stock bajo</strong></p>
        <p>El sistema marca en rojo los productos cuyo stock es igual o menor al stock mÃ­nimo deseado.</p>

        <hr>

        <p><strong>ğŸ“Š 7. Ver estadÃ­sticas</strong></p>
        <p><em>Desde el Ã­ndice:</em> abrir el modal â€œVer estadÃ­sticas del dÃ­aâ€ para ver costos, venta esperada, ingreso y ganancia del dÃ­a y otros detalles.</p>
        <p><em>PÃ¡gina â€œEstadÃ­sticasâ€:</em> incluye resumen rÃ¡pido del dÃ­a, acumulados del mes, grÃ¡ficos por dÃ­a, top productos, ventas por categorÃ­a, detalle por producto y resumen diario del mes.</p>

        <hr>

        <p><strong>ğŸ“… 8. Cerrar el dÃ­a</strong></p>
        <p>Cada cierre:</p>
        <ul>
          <li>Guarda un registro inalterable en el historial (fecha, ingreso, ganancia, costo vendido, productos vendidos).</li>
          <li>Pone en cero los valores del dÃ­a (vendidos, ganancia del dÃ­a, ingreso, turnos, resumen del dÃ­a), excepto los productos con stock.</li>
          <li>Mantiene la venta esperada (por el stock que quedÃ³).</li>
          <li>Actualiza acumulados del mes (ingreso, ganancia, costo vendido).</li>
          <li>No cambia de dÃ­a automÃ¡ticamente: el sistema solo avanza de fecha cuando son las 23:59 y pasa la medianoche.</li>
        </ul>

        <hr>

        <p><strong>ğŸ“‰ 9. GrÃ¡ficos del mes</strong></p>
        <p>Los grÃ¡ficos aparecen cuando hay registros historicos (se haya cerrado el dÃ­a al menos una vez en el mes): ingreso por dÃ­a, ganancia por dÃ­a, costo vendido por dÃ­a, y tabla del resumen diario del mes.</p>

        <hr>

        <p><strong>ğŸ›‘ 10. Casos especiales</strong></p>
        <p><strong>Si no queda stock en ningÃºn producto:</strong> el sistema NO pasarÃ¡ automÃ¡ticamente al dÃ­a siguiente. PodÃ©s reponer stock o crear productos y seguir vendiendo el mismo dÃ­a. Solo cambia al dÃ­a siguiente tras el cierre y al cruzar la medianoche (23:59).</p>

        <hr>

        <p><strong>ğŸ¯ 11. Objetivo del sistema</strong></p>
        <p>Registrar el flujo diario real sin forzar cierres. Control de stock, ventas, ganancias, ingresos por turno y rendimiento mensual con historial dÃ­a por dÃ­a.</p>

        <hr>

        <p><em>Consejo:</em> consultÃ¡ la consola del navegador si algo raro aparece; ahÃ­ verÃ¡s errores y avisos que ayudan a depurar.</p>
      </div>
    </div>
  </div>

  <!-- ============================
        ğŸŒ™ TEMA OSCURO / CLARO 
       ============================ -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("toggleThemeBtn");

      document.body.style.transition =
        "background-color 0.35s ease, color 0.35s ease";

      function activarSegunHora() {
          const h = new Date().getHours();
          return (h >= 19 || h < 7);
      }

      let guardado = localStorage.getItem("darkMode");
      let usarDark = guardado === null ? activarSegunHora() : guardado === "true";

      if (usarDark) document.body.classList.add("dark");

      if (btn) btn.textContent = usarDark ? "â˜€ï¸ Modo claro" : "ğŸŒ™ Modo oscuro";

      if (btn) btn.addEventListener("click", () => {
          document.body.classList.toggle("dark");
          const dark = document.body.classList.contains("dark");
          localStorage.setItem("darkMode", dark);
          btn.textContent = dark ? "â˜€ï¸ Modo claro" : "ğŸŒ™ Modo oscuro";
          document.dispatchEvent(new Event('themeChanged'));
      });

      // ---- Modal guÃ­a open/close
      const modal = document.getElementById("modalGuia");
      const openBtn = document.getElementById("guideBtn");
      const closeBtn = document.getElementById("modalGuiaClose");

      function abrirModalGuia() {
          if (!modal) return;
          modal.setAttribute('aria-hidden', 'false');
          modal.style.display = 'flex';
          // lock scroll
          document.documentElement.style.overflow = 'hidden';
      }
      function cerrarModalGuia() {
          if (!modal) return;
          modal.setAttribute('aria-hidden', 'true');
          modal.style.display = 'none';
          document.documentElement.style.overflow = '';
      }

      if (openBtn) openBtn.addEventListener('click', abrirModalGuia);
      if (closeBtn) closeBtn.addEventListener('click', cerrarModalGuia);
      // close on ESC
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') cerrarModalGuia(); });
      // click outside to close
      if (modal) modal.addEventListener('click', (ev) => { if (ev.target === modal) cerrarModalGuia(); });
  });
  </script>

  <!-- ============================
        ğŸ¨ PALETA PARA CHART.JS 
       ============================ -->
  <script>
  window.chartThemes = {
      getColors() {
          const dark = document.body.classList.contains("dark");

          return {
              text: dark ? "#ffffff" : "#222222",
              grid: dark ? "rgba(255,255,255,0.18)" : "rgba(0,0,0,0.15)",
              border: dark ? "#dddddd" : "#444444",
              barColors: dark
                  ? ["#66ccff", "#ffcc66", "#99ff99", "#ff9999", "#cc99ff"]
                  : ["#3366cc", "#ff9933", "#33aa33", "#cc3333", "#9933cc"],
              donutColors: dark
                  ? ["#66ccff", "#99ff99", "#ffcc66", "#ff9999"]
                  : ["#3366cc", "#33aa33", "#ff9933", "#cc3333"]
          };
      },

      applyToChart(chart) {
          const C = this.getColors();

          chart.options.plugins.legend.labels.color = C.text;
          if (chart.options.plugins.title) {
              chart.options.plugins.title.color = C.text;
          }

          if (chart.options.scales) {
              Object.values(chart.options.scales).forEach(scale => {
                  scale.ticks.color = C.text;
                  scale.grid.color = C.grid;
                  scale.grid.borderColor = C.border;
              });
          }

          chart.update();
      },

      recolorAll() {
          if (!window.allCharts) return;
          window.allCharts.forEach((ch) => this.applyToChart(ch));
      }
  };

  document.addEventListener("DOMContentLoaded", () => {
      const observer = new MutationObserver(() => window.chartThemes.recolorAll());
      observer.observe(document.body, { attributes: true, attributeFilter: ["class"] });
  });
  </script>

  <!-- ============================
        ESTILOS MÃNIMOS PARA MODAL 
       ============================ -->
  <style>
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.45);
      z-index: 9999;
      padding: 20px;
    }
    .modal .modal-content {
      background: var(--bg-panel, #fff);
      color: var(--text, #222);
      max-width: 820px;
      width: 100%;
      max-height: 80vh;
      overflow: auto;
      border-radius: 8px;
      padding: 18px;
      position: relative;
      box-shadow: 0 6px 24px rgba(0,0,0,0.18);
    }
    .modal .modal-close {
      position: absolute;
      right: 10px;
      top: 10px;
      background: transparent;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }
    .modal h2 { margin-top: 0; }
    .modal-body { font-size: 14px; line-height: 1.4; }
    body.dark .modal .modal-content { background: #111; color: #eee; }
  </style>
  <script type="module" src="poo/estadisticas.js"></script>

</body>
</html>
